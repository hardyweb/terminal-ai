<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal AI ü§ñ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .message-animate { animation: messageSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .typing-dot {
            width: 6px; height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0.32s; }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #0f172a; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .glass-effect {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        
        .message-bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        
        .message-bubble.user {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }
        
        .message-bubble.assistant {
            background: #1e293b;
            color: #e2e8f0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .rag-context {
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .rag-doc-item {
            background: rgba(15, 23, 42, 0.6);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 6px 0;
            font-size: 12px;
            color: #94a3b8;
            border-left: 2px solid #10b981;
        }
        
        .input-field {
            background: #0f172a;
            border: 1.5px solid #334155;
            border-radius: 12px;
            padding: 14px 16px;
            color: #e2e8f0;
            font-size: 15px;
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 12px;
            padding: 14px 24px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #1e293b;
            color: #e2e8f0;
            border: 1.5px solid #334155;
            border-radius: 12px;
            padding: 14px 24px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: #334155;
            border-color: #475569;
        }
        
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .skill-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 14px 16px;
            margin: 8px 0;
            border-left: 3px solid #10b981;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .skill-card:hover {
            background: #1e293b;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @media (max-width: 1024px) {
            .sidebar { position: fixed; top: 0; right: 0; height: 100vh; width: 320px; z-index: 50; }
            .sidebar.hidden { transform: translateX(100%); }
            .sidebar-overlay { display: none; }
            .sidebar-overlay.show { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
        }
        
        @media (min-width: 1025px) {
            .sidebar-overlay { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="card w-full max-w-md p-8">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">ü§ñ</div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-emerald-400 to-emerald-600 bg-clip-text text-transparent mb-2">
                    Terminal AI
                </h1>
                <p class="text-slate-400 text-sm">Secure AI assistant for your notes</p>
            </div>
            
            <div id="loginError" class="hidden mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-sm"></div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Username</label>
                    <input type="text" id="username" placeholder="Enter your username" 
                           class="input-field w-full" autocomplete="username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" 
                           class="input-field w-full" autocomplete="current-password">
                </div>
                
                <button onclick="login()" class="btn-primary w-full flex items-center justify-center gap-2">
                    <span id="loginIcon">üîê</span>
                    <span id="loginText">Sign In</span>
                </button>
            </div>
            
            <p class="text-center text-slate-500 text-xs mt-6">
                üîí Secure ‚Ä¢ üîê Encrypted ‚Ä¢ üõ°Ô∏è Private
            </p>
        </div>
    </div>
    
    <!-- Main Chat Interface -->
    <div id="mainApp" class="hidden min-h-screen flex flex-col">
        <!-- Header -->
        <header class="glass-effect sticky top-0 z-30 px-4 py-3 lg:px-6">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center gap-3">
                    <button id="mobileMenuBtn" onclick="toggleSidebar()" class="lg:hidden p-2 rounded-xl hover:bg-slate-800 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ü§ñ</span>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-emerald-400 to-emerald-600 bg-clip-text text-transparent hidden sm:block">
                            Terminal AI
                        </h1>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="currentUser" class="text-sm text-slate-400 hidden sm:inline"></span>
                    <button onclick="logout()" class="btn-secondary text-sm px-4 py-2 flex items-center gap-2">
                        <span>üö™</span>
                        <span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col lg:flex-row max-w-7xl mx-auto w-full p-4 gap-4">
            <!-- Chat Area -->
            <div class="flex-1 flex flex-col card overflow-hidden min-h-0">
                <!-- Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-4">
                    <div class="message-animate message-bubble assistant">
                        üëã Welcome to Terminal AI! I'm ready to help you with your notes and documents.
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="border-t border-slate-700 p-4 bg-slate-900/50">
                    <div class="flex gap-3 items-end">
                         <input type="text" id="messageInput" 
                                placeholder="Ask me anything about your notes..." 
                                class="input-field flex-1 resize-none" 
                                onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
                        <select id="providerSelect" class="input-field cursor-pointer">
                            <option value="">Loading...</option>
                        </select>
                        <button onclick="sendMessage()" class="btn-primary px-5 py-3 flex items-center gap-2">
                            <span id="sendIcon">üì§</span>
                            <span class="hidden sm:inline">Send</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
            <div id="sidebar" class="sidebar w-full lg:w-96 flex flex-col gap-4 overflow-y-auto lg:overflow-visible hidden lg:flex">
                <!-- Quick Stats -->
                <div class="card p-5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">‚ö°</span>
                        Quick Stats
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-emerald-400" id="ragDocCount">-</div>
                            <div class="text-xs text-slate-400 mt-1">Indexed Docs</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-emerald-400" id="skillCount">-</div>
                            <div class="text-xs text-slate-400 mt-1">Skills</div>
                        </div>
                    </div>
                </div>
                
                <!-- Skills -->
                <div class="card p-5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üéØ</span>
                        Active Skills
                    </h3>
                    <div id="skillsList">
                        <div class="flex items-center gap-2 text-slate-400">
                            <div class="w-4 h-4 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-sm">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Chat History -->
                <div class="card p-5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üí¨</span>
                        Chat History
                    </h3>
                    <div id="chatHistoryList" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="flex items-center gap-2 text-slate-400">
                            <div class="w-4 h-4 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-sm">Loading...</span>
                        </div>
                    </div>
                    <button onclick="startNewChat()" class="btn-primary w-full mt-4">
                        ‚ú® New Chat
                    </button>
                </div>
                
                <!-- RAG Status -->
                <div class="card p-5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üìö</span>
                        RAG Status
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400">Index Status</span>
                            <span id="ragIndexStatus" class="text-emerald-400">Loading...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400">Last Updated</span>
                            <span id="ragLastUpdate" class="text-slate-500">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400">AI Provider</span>
                            <span class="text-emerald-400">Active</span>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card p-5">
                    <button onclick="openSettings()" class="w-full btn-secondary flex items-center justify-center gap-2">
                        <span>‚öôÔ∏è</span>
                        <span>Provider Settings</span>
                    </button>
                    <p class="text-xs text-slate-500 mt-2 text-center">
                        Add, manage, and configure AI providers
                    </p>
                </div>

                <!-- Close Sidebar Button (Mobile) -->
                <button onclick="closeSidebar()" class="lg:hidden btn-secondary w-full">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="card w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <span>‚öôÔ∏è</span>
                    <span>Provider Settings</span>
                </h2>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="p-6 flex-1 overflow-y-auto">
                <!-- Add New Provider Form -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">‚ûï</span>
                        <span>Add New Provider</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="newProviderName" placeholder="Provider Name" class="input-field">
                        <input type="number" id="newProviderPriority" placeholder="Priority (0=highest)" class="input-field" min="0">
                        <input type="text" id="newProviderEndpoint" placeholder="Endpoint URL" class="input-field md:col-span-2">
                        <input type="text" id="newProviderModel" placeholder="Model Name" class="input-field">
                        <input type="password" id="newProviderApiKey" placeholder="API Key (optional)" class="input-field">
                    </div>
                    <button onclick="addNewProvider()" class="btn-primary mt-4">
                        Add Provider
                    </button>
                </div>

                <!-- Providers List -->
                <div>
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üìã</span>
                        <span>Configured Providers</span>
                    </h3>
                    <div id="providersList" class="space-y-3">
                        <div class="flex items-center gap-2 text-slate-400">
                            <div class="w-4 h-4 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-sm">Loading providers...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let token = localStorage.getItem('token');
        let username = localStorage.getItem('username');
        let chatHistory = [];
        let isLoading = false;
        let sidebarOpen = false;
        let currentSessionId = null;
        const API_BASE = window.location.origin;
        
        function checkAuth() {
            const storedToken = localStorage.getItem('token');
            const storedUsername = localStorage.getItem('username');
            console.log('Checking auth, token:', storedToken ? 'exists' : 'none', 'username:', storedUsername);
            
            if (storedToken) {
                token = storedToken;
                username = storedUsername;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('currentUser').textContent = `üë§ ${username}`;
                loadDashboard();
            }
        }
        
        async function login() {
            const inputUsername = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!inputUsername || !password) {
                showError('Please enter username and password');
                return;
            }
            
            const btn = document.querySelector('#loginScreen .btn-primary');
            btn.disabled = true;
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
            
            try {
                const response = await fetch(API_BASE + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: inputUsername, password })
                });
                
                const text = await response.text();
                console.log('Login response:', text);
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('Failed to parse response:', e);
                    showError('Invalid response from server');
                    return;
                }
                
                if (!response.ok) {
                    showError(data.error || 'Login failed');
                    return;
                }
                
                if (data.token) {
                    token = data.token;
                    username = data.username;
                    localStorage.setItem('token', token);
                    localStorage.setItem('username', username);
                    checkAuth();
                } else {
                    showError(data.error || 'No token received');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Connection error: ' + error.message);
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span>üîê</span><span>Sign In</span>';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }
        
        function logout() {
            fetch(API_BASE + '/api/logout', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            token = null;
            location.reload();
        }
        
        function addMessage(role, content, ragContext = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble ' + role + ' message-animate';
            
            let html = formatContent(content);
            
            if (ragContext) {
                html += `
                    <div class="rag-context">
                        <div class="flex items-center gap-2 font-semibold text-emerald-400 mb-2 text-sm">
                            <span>üìö</span>
                            <span>Relevant Documents Found</span>
                        </div>
                        ${ragContext}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = html;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
        }
        
        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message-bubble assistant message-animate';
            typingDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="flex gap-1">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span class="text-slate-400 text-sm">AI is typing...</span>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function formatContent(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-emerald-300">$1</strong>')
                .replace(/`([^`]+)`/g, '<code class="bg-slate-800 px-2 py-1 rounded text-sm text-emerald-400">$1</code>')
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-slate-800 p-3 rounded-lg mt-2 mb-2 overflow-x-auto text-sm"><code>$1</code></pre>');
        }
        
        async function sendMessage() {
            if (isLoading) return;
            
            const message = document.getElementById('messageInput').value.trim();
            if (!message) return;
            
            isLoading = true;
            const input = document.getElementById('messageInput');
            const sendBtn = document.querySelector('#mainApp .btn-primary');
            const provider = document.getElementById('providerSelect').value;
            
            input.disabled = true;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
            
            addMessage('user', message);
            chatHistory.push({ role: 'user', content: message });
            input.value = '';
            
            showTypingIndicator();

            try {
                let response;
                let data;

                if (currentSessionId) {
                    response = await fetch(`/api/history/${currentSessionId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ message, provider })
                    });

                    const text = await response.text();
                    console.log('Update session response:', text);
                    data = JSON.parse(text);
                } else {
                    response = await fetch('/api/history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ message, provider })
                    });

                    const text = await response.text();
                    console.log('Create session response:', text);
                    data = JSON.parse(text);

                    if (data.session_id) {
                        currentSessionId = data.session_id;
                    }
                }

                hideTypingIndicator();

                if (data.response) {
                    addMessage('assistant', data.response);
                    chatHistory.push({ role: 'assistant', content: data.response });
                    loadChatHistory();
                } else {
                    addMessage('assistant', '‚ùå ' + (data.error || 'Failed to get response'));
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('assistant', '‚ùå Sorry, I encountered an error. Please try again.');
            }
            
            isLoading = false;
            input.disabled = false;
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<span id="sendIcon">üì§</span><span class="hidden sm:inline">Send</span>';
            input.focus();
        }
        
        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebarOpen) {
                sidebar.classList.remove('hidden');
                overlay.classList.add('show');
            } else {
                sidebar.classList.add('hidden');
                overlay.classList.remove('show');
            }
        }
        
        function closeSidebar() {
            sidebarOpen = false;
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('sidebarOverlay').classList.remove('show');
        }

        async function loadDashboard() {
            await Promise.all([loadSkills(), loadRAGStats(), loadChatHistory(), loadProviderSelect()]);
        }

        async function loadProviderSelect() {
            try {
                const response = await fetch('/api/providers', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const providers = await response.json();

                const select = document.getElementById('providerSelect');
                const currentValue = select.value;

                select.innerHTML = providers.map(p => `
                    <option value="${p.name}" ${p.is_default ? 'selected' : ''} ${!p.enabled ? 'disabled' : ''}>
                        ${p.byok ? 'üîê' : 'üåê'} ${p.name} ${p.is_default ? '(Default)' : ''}
                    </option>
                `).join('');

                if (currentValue && providers.find(p => p.name === currentValue)) {
                    select.value = currentValue;
                }
            } catch (error) {
                console.error('Failed to load providers:', error);
                const select = document.getElementById('providerSelect');
                select.innerHTML = `<option value="">Error: ${error.message}</option>`;
            }
        }


        async function loadSkills() {
            try {
                const response = await fetch('/api/skills', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                
                const skillsList = document.getElementById('skillsList');
                document.getElementById('skillCount').textContent = data.length || 0;
                
                if (!data || data.length === 0) {
                    skillsList.innerHTML = '<p class="text-slate-500 text-sm">No skills available</p>';
                    return;
                }
                
                skillsList.innerHTML = data.map(skill => `
                    <div class="skill-card" onclick="useSkill('${skill.name}')">
                        <div class="font-semibold text-emerald-400 text-sm">üéØ ${skill.name}</div>
                        <div class="text-xs text-slate-400 mt-1">${skill.description}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load skills:', error);
                document.getElementById('skillsList').innerHTML = '<p class="text-slate-500 text-sm">Failed to load skills</p>';
            }
        }
        
        async function loadRAGStats() {
            try {
                const response = await fetch('/api/rag/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ query: 'test' })
                });
                
                const data = await response.json();
                const docCount = data.results ? data.results.length : (data.count || 0);
                document.getElementById('ragDocCount').textContent = docCount > 0 ? docCount : '-';
                document.getElementById('ragIndexStatus').textContent = docCount > 0 ? '‚úÖ Active' : '‚ö†Ô∏è No docs';
                document.getElementById('ragLastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                document.getElementById('ragDocCount').textContent = '?';
                document.getElementById('ragIndexStatus').textContent = '‚ö†Ô∏è Error';
            }
        }
        
        function useSkill(skillName) {
            document.getElementById('messageInput').value = `${skillName}: `;
            document.getElementById('messageInput').focus();
        }

        async function loadChatHistory() {
            try {
                const response = await fetch('/api/history', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const sessions = await response.json();
                renderChatHistory(sessions);
            } catch (error) {
                console.error('Failed to load chat history:', error);
                document.getElementById('chatHistoryList').innerHTML =
                    '<p class="text-slate-500 text-sm">Failed to load history</p>';
            }
        }

        function renderChatHistory(sessions) {
            const historyList = document.getElementById('chatHistoryList');

            if (!sessions || sessions.length === 0) {
                historyList.innerHTML = '<p class="text-slate-500 text-sm">No chat sessions</p>';
                return;
            }

            historyList.innerHTML = sessions.map(session => `
                <div class="bg-slate-800/50 rounded-lg p-3 cursor-pointer hover:bg-slate-700/50 transition-colors border border-slate-700 ${currentSessionId === session.id ? 'border-emerald-500' : ''}" onclick="loadSession('${session.id}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-sm text-slate-200 truncate">${escapeHtml(session.title)}</div>
                            <div class="text-xs text-slate-400 mt-1">${session.messages.length} messages</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteSession('${session.id}')" class="text-slate-500 hover:text-red-400 transition-colors ml-2">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadSession(sessionId) {
            try {
                const response = await fetch(`/api/history/${sessionId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const session = await response.json();

                currentSessionId = sessionId;
                document.getElementById('chatMessages').innerHTML = '';

                session.messages.forEach(msg => {
                    if (msg.role === 'user') {
                        addMessage('user', msg.content);
                    } else {
                        addMessage('assistant', msg.content);
                    }
                });

                loadChatHistory();
            } catch (error) {
                console.error('Failed to load session:', error);
                addMessage('assistant', '‚ùå Failed to load session');
            }
        }

        async function startNewChat() {
            currentSessionId = null;
            document.getElementById('chatMessages').innerHTML = `
                <div class="message-animate message-bubble assistant">
                    üëã Welcome to Terminal AI! I'm ready to help you with your notes and documents.
                </div>
            `;
            loadChatHistory();
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this chat session?')) {
                return;
            }

            try {
                await fetch(`/api/history/${sessionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (currentSessionId === sessionId) {
                    startNewChat();
                } else {
                    loadChatHistory();
                }
            } catch (error) {
                console.error('Failed to delete session:', error);
                alert('Failed to delete session');
            }
        }

        async function saveMessageToSession(role, content) {
            if (!currentSessionId) {
                return;
            }

            try {
                await fetch(`/api/history/${currentSessionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        message: role === 'user' ? content : null,
                        provider: document.getElementById('providerSelect').value
                    })
                });
            } catch (error) {
                console.error('Failed to save message:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 500);
            checkAuth();
        });
        
        document.getElementById('messageInput').addEventListener('input', function(e) {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        async function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            await loadProviders();
        }

        async function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            await loadProviderSelect();
        }

        async function loadProviders() {
            try {
                const response = await fetch('/api/providers', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const providers = await response.json();
                renderProviders(providers);
            } catch (error) {
                console.error('Failed to load providers:', error);
                document.getElementById('providersList').innerHTML =
                    `<div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-red-400">
                        <div class="font-semibold mb-1">Failed to load providers</div>
                        <div class="text-sm text-slate-400">${error.message}</div>
                    </div>`;
            }
        }

        function renderProviders(providers) {
            const list = document.getElementById('providersList');

            if (!providers || providers.length === 0) {
                list.innerHTML = '<p class="text-slate-500 text-sm">No providers configured</p>';
                return;
            }

            list.innerHTML = providers.map(p => `
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 ${p.enabled ? '' : 'opacity-60'}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h4 class="font-semibold text-lg">${escapeHtml(p.name)}</h4>
                                ${p.is_default ? '<span class="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-1 rounded-full">DEFAULT</span>' : ''}
                                ${p.byok ? '<span class="bg-blue-500/20 text-blue-400 text-xs px-2 py-1 rounded-full">BYOK</span>' : ''}
                                ${p.enabled ? '<span class="bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded-full">ENABLED</span>' : '<span class="bg-red-500/20 text-red-400 text-xs px-2 py-1 rounded-full">DISABLED</span>'}
                            </div>
                            <div class="text-sm text-slate-400 mt-1">Priority: ${p.priority}</div>
                            <div class="text-sm text-slate-400">Model: ${escapeHtml(p.model)}</div>
                            <div class="text-xs text-slate-500 mt-1 break-all">Endpoint: ${escapeHtml(p.endpoint)}</div>
                        </div>
                        <button onclick="deleteProvider('${p.name}')" class="text-red-400 hover:text-red-300 transition-colors">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${p.enabled ? `
                            <button onclick="toggleProvider('${p.name}', false)" class="btn-secondary text-xs px-3 py-1">
                                Disable
                            </button>
                        ` : `
                            <button onclick="toggleProvider('${p.name}', true)" class="btn-primary text-xs px-3 py-1">
                                Enable
                            </button>
                        `}
                        <button onclick="testProvider('${p.name}')" class="btn-secondary text-xs px-3 py-1">
                            Test
                        </button>
                        <button onclick="setDefaultProvider('${p.name}')" class="btn-secondary text-xs px-3 py-1">
                            Set Default
                        </button>
                        <div class="flex items-center gap-2 ml-auto">
                            <label class="text-sm text-slate-400">Priority:</label>
                            <input type="number" min="0" max="99" value="${p.priority}"
                                   onchange="updateProviderPriority('${p.name}', this.value)"
                                   class="bg-slate-900 border border-slate-700 rounded px-2 py-1 w-16 text-sm">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function addNewProvider() {
            const name = document.getElementById('newProviderName').value.trim();
            const priority = parseInt(document.getElementById('newProviderPriority').value) || 1;
            const endpoint = document.getElementById('newProviderEndpoint').value.trim();
            const model = document.getElementById('newProviderModel').value.trim();
            const apiKey = document.getElementById('newProviderApiKey').value.trim();

            if (!name || !endpoint || !model) {
                alert('Please fill in Name, Endpoint, and Model');
                return;
            }

            try {
                const response = await fetch('/api/providers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ name, priority, endpoint, model, api_key: apiKey })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                document.getElementById('newProviderName').value = '';
                document.getElementById('newProviderPriority').value = '';
                document.getElementById('newProviderEndpoint').value = '';
                document.getElementById('newProviderModel').value = '';
                document.getElementById('newProviderApiKey').value = '';

                await loadProviders();
                await loadProviderSelect();
            } catch (error) {
                alert('Failed to add provider: ' + error.message);
            }
        }

        async function toggleProvider(name, enabled) {
            try {
                const endpoint = enabled ? `/api/providers/${name}/enable` : `/api/providers/${name}/disable`;
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                await loadProviders();
            } catch (error) {
                alert('Failed to toggle provider: ' + error.message);
            }
        }

        async function testProvider(name) {
            try {
                const response = await fetch(`/api/providers/${name}/test`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const data = await response.json();
                alert(`Test successful!\nResponse: ${data.response}`);
            } catch (error) {
                alert('Test failed: ' + error.message);
            }
        }

        async function setDefaultProvider(name) {
            try {
                const response = await fetch(`/api/providers/${name}/default`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                await loadProviders();
            } catch (error) {
                alert('Failed to set default provider: ' + error.message);
            }
        }

        async function updateProviderPriority(name, priority) {
            try {
                const response = await fetch(`/api/providers/${name}/priority`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ priority: parseInt(priority) })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                await loadProviders();
            } catch (error) {
                alert('Failed to update priority: ' + error.message);
                await loadProviders();
            }
        }

        async function deleteProvider(name) {
            if (!confirm(`Delete provider '${name}'?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/providers/${name}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                await loadProviders();
            } catch (error) {
                alert('Failed to delete provider: ' + error.message);
            }
        }
    </script>
</body>
</html>
