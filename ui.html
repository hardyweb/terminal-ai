<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal AI ü§ñ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        
        :root {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #0f172a;
            --border-color: #334155;
            --border-hover: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-primary: #10b981;
            --accent-primary-dark: #059669;
            --accent-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --accent-300: #34d399;
            --message-user-bg: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --message-assistant-bg: #1e293b;
            --scrollbar-track: #0f172a;
            --scrollbar-thumb: #334155;
            --scrollbar-thumb-hover: #475569;
            --glass-bg: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(71, 85, 105, 0.5);
            --rag-context-bg: rgba(16, 185, 129, 0.08);
            --rag-context-border: rgba(16, 185, 129, 0.2);
            --rag-doc-bg: rgba(15, 23, 42, 0.6);
            --rag-doc-border: #10b981;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            --border-color: #e2e8f0;
            --border-hover: #cbd5e1;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --accent-primary: #0ea5e9;
            --accent-primary-dark: #0284c7;
            --accent-gradient: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            --accent-300: #38bdf8;
            --message-user-bg: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            --message-assistant-bg: #f8fafc;
            --scrollbar-track: #f1f5f9;
            --scrollbar-thumb: #cbd5e1;
            --scrollbar-thumb-hover: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(203, 213, 225, 0.5);
            --rag-context-bg: rgba(14, 165, 233, 0.08);
            --rag-context-border: rgba(14, 165, 233, 0.2);
            --rag-doc-bg: rgba(241, 245, 249, 0.6);
            --rag-doc-border: #0ea5e9;
        }

        [data-theme="midnight"] {
            --bg-primary: #0a0e27;
            --bg-secondary: #1a1f3a;
            --bg-card: #242945;
            --bg-input: #1a1f3a;
            --border-color: #3d4472;
            --border-hover: #4f56a0;
            --text-primary: #e4e7ff;
            --text-secondary: #a0a5d6;
            --text-muted: #6d72a0;
            --accent-primary: #a78bfa;
            --accent-primary-dark: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            --accent-300: #c4b5fd;
            --message-user-bg: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            --message-assistant-bg: #242945;
            --scrollbar-track: #1a1f3a;
            --scrollbar-thumb: #3d4472;
            --scrollbar-thumb-hover: #4f56a0;
            --glass-bg: rgba(36, 41, 69, 0.8);
            --glass-border: rgba(61, 68, 114, 0.5);
            --rag-context-bg: rgba(167, 139, 250, 0.08);
            --rag-context-border: rgba(167, 139, 250, 0.2);
            --rag-doc-bg: rgba(26, 31, 58, 0.6);
            --rag-doc-border: #a78bfa;
        }

        [data-theme="sunset"] {
            --bg-primary: #1a0a0a;
            --bg-secondary: #2d1b1b;
            --bg-card: #402525;
            --bg-input: #2d1b1b;
            --border-color: #6b4a4a;
            --border-hover: #8b5a5a;
            --text-primary: #ffe4e4;
            --text-secondary: #d4b8b8;
            --text-muted: #a88c8c;
            --accent-primary: #f97316;
            --accent-primary-dark: #ea580c;
            --accent-gradient: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            --accent-300: #fdba74;
            --message-user-bg: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            --message-assistant-bg: #402525;
            --scrollbar-track: #2d1b1b;
            --scrollbar-thumb: #6b4a4a;
            --scrollbar-thumb-hover: #8b5a5a;
            --glass-bg: rgba(64, 37, 37, 0.8);
            --glass-border: rgba(107, 74, 74, 0.5);
            --rag-context-bg: rgba(249, 115, 22, 0.08);
            --rag-context-border: rgba(249, 115, 22, 0.2);
            --rag-doc-bg: rgba(45, 27, 27, 0.6);
            --rag-doc-border: #f97316;
        }

        [data-theme="forest"] {
            --bg-primary: #0a1a0a;
            --bg-secondary: #0f2a0f;
            --bg-card: #1a3a1a;
            --bg-input: #0f2a0f;
            --border-color: #2d5a2d;
            --border-hover: #3d7a3d;
            --text-primary: #e4ffe4;
            --text-secondary: #b8e4b8;
            --text-muted: #8cc48c;
            --accent-primary: #22c55e;
            --accent-primary-dark: #16a34a;
            --accent-gradient: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --accent-300: #4ade80;
            --message-user-bg: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --message-assistant-bg: #1a3a1a;
            --scrollbar-track: #0f2a0f;
            --scrollbar-thumb: #2d5a2d;
            --scrollbar-thumb-hover: #3d7a3d;
            --glass-bg: rgba(26, 58, 26, 0.8);
            --glass-border: rgba(45, 90, 45, 0.5);
            --rag-context-bg: rgba(34, 197, 94, 0.08);
            --rag-context-border: rgba(34, 197, 94, 0.2);
            --rag-doc-bg: rgba(15, 42, 15, 0.6);
            --rag-doc-border: #22c55e;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .message-animate { animation: messageSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .typing-dot {
            width: 6px; height: 6px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0.32s; }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
        
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        
        .message-bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        
        .message-bubble.user {
            background: var(--message-user-bg);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }
        
        .message-bubble.assistant {
            background: var(--message-assistant-bg);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .rag-context {
            background: var(--rag-context-bg);
            border: 1px solid var(--rag-context-border);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .rag-doc-item {
            background: var(--rag-doc-bg);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 6px 0;
            font-size: 12px;
            color: var(--text-secondary);
            border-left: 2px solid var(--rag-doc-border);
        }
        
        .input-field {
            background: var(--bg-input);
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-primary), transparent 90%);
        }
        
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            border-radius: 12px;
            padding: 14px 24px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px color-mix(in srgb, var(--accent-primary), transparent 70%);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-primary), transparent 60%);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 24px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: var(--border-color);
            border-color: var(--border-hover);
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .skill-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 16px;
            margin: 8px 0;
            border-left: 3px solid var(--accent-primary);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .skill-card:hover {
            background: var(--bg-card);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @media (max-width: 1024px) {
            .sidebar { position: fixed; top: 0; right: 0; height: 100vh; width: 320px; z-index: 50; }
            .sidebar.hidden { transform: translateX(100%); }
            .sidebar-overlay { display: none; }
            .sidebar-overlay.show { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
        }
        
        @media (min-width: 1025px) {
            .sidebar-overlay { display: none !important; }
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .bg-slate-950 { background-color: var(--bg-primary); }
        .bg-slate-900 { background-color: var(--bg-secondary); }
        .bg-slate-800 { background-color: var(--bg-card); }
        .text-slate-100 { color: var(--text-primary); }
        .text-slate-200 { color: var(--text-primary); }
        .text-slate-300 { color: var(--text-primary); }
        .text-slate-400 { color: var(--text-secondary); }
        .text-slate-500 { color: var(--text-muted); }
        .border-slate-700 { border-color: var(--border-color); }
        .text-emerald-400 { color: var(--accent-300); }
        .text-emerald-300 { color: var(--accent-300); }
        .from-emerald-400 { --tw-gradient-from: var(--accent-primary); }
        .to-emerald-600 { --tw-gradient-to: var(--accent-primary-dark); }
        .bg-emerald-500\/20 { background-color: color-mix(in srgb, var(--accent-primary), transparent 80%); }
        .bg-emerald-500\/10 { background-color: color-mix(in srgb, var(--accent-primary), transparent 90%); }
        .text-emerald-500 { color: var(--accent-primary); }
        .bg-slate-800\/50 { background-color: color-mix(in srgb, var(--bg-card), transparent 50%); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="card w-full max-w-md p-8">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">ü§ñ</div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-emerald-400 to-emerald-600 bg-clip-text text-transparent mb-2">
                    Terminal AI
                </h1>
                <p class="text-slate-400 text-sm">Secure AI assistant for your notes</p>
            </div>
            
            <div id="loginError" class="hidden mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-sm"></div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Username</label>
                    <input type="text" id="username" placeholder="Enter your username" 
                           class="input-field w-full" autocomplete="username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" 
                           class="input-field w-full" autocomplete="current-password">
                </div>
                
                <button onclick="login()" class="btn-primary w-full flex items-center justify-center gap-2">
                    <span id="loginIcon">üîê</span>
                    <span id="loginText">Sign In</span>
                </button>
            </div>
            
            <p class="text-center text-slate-500 text-xs mt-6">
                üîí Secure ‚Ä¢ üîê Encrypted ‚Ä¢ üõ°Ô∏è Private
            </p>
        </div>
    </div>
    
    <!-- Main Chat Interface -->
    <div id="mainApp" class="hidden min-h-screen flex flex-col">
        <!-- Header -->
        <header class="glass-effect sticky top-0 z-30 px-4 py-3 lg:px-6">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center gap-3">
                    <button id="mobileMenuBtn" onclick="toggleSidebar()" class="lg:hidden p-2 rounded-xl hover:bg-slate-800 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ü§ñ</span>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-emerald-400 to-emerald-600 bg-clip-text text-transparent hidden sm:block">
                            Terminal AI
                        </h1>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="currentUser" class="text-sm text-slate-400 hidden sm:inline"></span>
                    <button onclick="logout()" class="btn-secondary text-sm px-4 py-2 flex items-center gap-2">
                        <span>üö™</span>
                        <span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col lg:flex-row max-w-7xl mx-auto w-full p-4 gap-4">
            <!-- Chat Area -->
            <div class="flex-1 flex flex-col card overflow-hidden min-h-0">
                <!-- Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-4">
                    <div class="message-animate message-bubble assistant">
                        üëã Welcome to Terminal AI! I'm ready to help you with your notes and documents.
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="border-t border-slate-700 p-4 bg-slate-900/50">
                    <div class="flex gap-3 items-end">
                         <input type="text" id="messageInput" 
                                placeholder="Ask me anything about your notes..." 
                                class="input-field flex-1 resize-none" 
                                onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
                        <select id="providerSelect" class="input-field cursor-pointer">
                            <option value="">Loading...</option>
                        </select>
                        <button onclick="sendMessage()" class="btn-primary px-5 py-3 flex items-center gap-2">
                            <span id="sendIcon">üì§</span>
                            <span class="hidden sm:inline">Send</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
            <div id="sidebar" class="sidebar w-full lg:w-96 flex flex-col gap-4 overflow-y-auto lg:overflow-visible hidden lg:flex">
                <!-- Quick Stats -->
                <div class="card p-5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">‚ö°</span>
                        Quick Stats
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-emerald-400" id="ragDocCount">-</div>
                            <div class="text-xs text-slate-400 mt-1">Indexed Docs</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-emerald-400" id="skillCount">-</div>
                            <div class="text-xs text-slate-400 mt-1">Skills</div>
                        </div>
                    </div>
                </div>
                
                <!-- Skills -->
                <div class="card p-5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üéØ</span>
                        Active Skills
                    </h3>
                    <div id="skillsList">
                        <div class="flex items-center gap-2 text-slate-400">
                            <div class="w-4 h-4 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-sm">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Chat History -->
                <div class="card p-5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üí¨</span>
                        Chat History
                    </h3>
                    <div id="chatHistoryList" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="flex items-center gap-2 text-slate-400">
                            <div class="w-4 h-4 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-sm">Loading...</span>
                        </div>
                    </div>
                    <button onclick="startNewChat()" class="btn-primary w-full mt-4">
                        ‚ú® New Chat
                    </button>
                </div>
                
                <!-- RAG Status -->
                <div class="card p-5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üìö</span>
                        RAG Status
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400">Index Status</span>
                            <span id="ragIndexStatus" class="text-emerald-400">Loading...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400">Last Updated</span>
                            <span id="ragLastUpdate" class="text-slate-500">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400">AI Provider</span>
                            <span class="text-emerald-400">Active</span>
                        </div>
                    </div>
                </div>

                <!-- Theme Settings -->
                <div class="card p-5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üé®</span>
                        Theme
                    </h3>
                    <div class="grid grid-cols-5 gap-2">
                        <button onclick="setTheme('dark')" class="theme-btn p-2 rounded-lg border border-slate-700 hover:border-emerald-500 transition-all" data-theme="dark" title="Dark">
                            <div class="w-full h-8 rounded bg-gradient-to-br from-slate-900 to-slate-700"></div>
                            <div class="text-xs text-center mt-1 text-slate-400">Dark</div>
                        </button>
                        <button onclick="setTheme('light')" class="theme-btn p-2 rounded-lg border border-slate-700 hover:border-emerald-500 transition-all" data-theme="light" title="Light">
                            <div class="w-full h-8 rounded bg-gradient-to-br from-slate-100 to-slate-300"></div>
                            <div class="text-xs text-center mt-1 text-slate-400">Light</div>
                        </button>
                        <button onclick="setTheme('midnight')" class="theme-btn p-2 rounded-lg border border-slate-700 hover:border-emerald-500 transition-all" data-theme="midnight" title="Midnight">
                            <div class="w-full h-8 rounded bg-gradient-to-br from-purple-900 to-indigo-800"></div>
                            <div class="text-xs text-center mt-1 text-slate-400">Midnight</div>
                        </button>
                        <button onclick="setTheme('sunset')" class="theme-btn p-2 rounded-lg border border-slate-700 hover:border-emerald-500 transition-all" data-theme="sunset" title="Sunset">
                            <div class="w-full h-8 rounded bg-gradient-to-br from-red-900 to-orange-700"></div>
                            <div class="text-xs text-center mt-1 text-slate-400">Sunset</div>
                        </button>
                        <button onclick="setTheme('forest')" class="theme-btn p-2 rounded-lg border border-slate-700 hover:border-emerald-500 transition-all" data-theme="forest" title="Forest">
                            <div class="w-full h-8 rounded bg-gradient-to-br from-green-900 to-green-700"></div>
                            <div class="text-xs text-center mt-1 text-slate-400">Forest</div>
                        </button>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card p-5">
                    <button onclick="openSettings()" class="w-full btn-secondary flex items-center justify-center gap-2">
                        <span>‚öôÔ∏è</span>
                        <span>Provider Settings</span>
                    </button>
                    <p class="text-xs text-slate-500 mt-2 text-center">
                        Add, manage, and configure AI providers
                    </p>
                </div>

                <!-- Close Sidebar Button (Mobile) -->
                <button onclick="closeSidebar()" class="lg:hidden btn-secondary w-full">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="card w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <span>‚öôÔ∏è</span>
                    <span>Provider Settings</span>
                </h2>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="p-6 flex-1 overflow-y-auto">
                <!-- Theme Settings -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üé®</span>
                        <span>Theme Settings</span>
                    </h3>
                    <div class="grid grid-cols-5 gap-3">
                        <button onclick="setTheme('dark')" class="theme-btn p-3 rounded-xl border border-slate-700 hover:border-emerald-500 transition-all flex flex-col items-center" data-theme="dark">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-slate-900 to-slate-700 mb-2"></div>
                            <span class="text-sm text-slate-400">Dark</span>
                        </button>
                        <button onclick="setTheme('light')" class="theme-btn p-3 rounded-xl border border-slate-700 hover:border-emerald-500 transition-all flex flex-col items-center" data-theme="light">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-slate-100 to-slate-300 mb-2"></div>
                            <span class="text-sm text-slate-400">Light</span>
                        </button>
                        <button onclick="setTheme('midnight')" class="theme-btn p-3 rounded-xl border border-slate-700 hover:border-emerald-500 transition-all flex flex-col items-center" data-theme="midnight">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-900 to-indigo-800 mb-2"></div>
                            <span class="text-sm text-slate-400">Midnight</span>
                        </button>
                        <button onclick="setTheme('sunset')" class="theme-btn p-3 rounded-xl border border-slate-700 hover:border-emerald-500 transition-all flex flex-col items-center" data-theme="sunset">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-red-900 to-orange-700 mb-2"></div>
                            <span class="text-sm text-slate-400">Sunset</span>
                        </button>
                        <button onclick="setTheme('forest')" class="theme-btn p-3 rounded-xl border border-slate-700 hover:border-emerald-500 transition-all flex flex-col items-center" data-theme="forest">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-green-900 to-green-700 mb-2"></div>
                            <span class="text-sm text-slate-400">Forest</span>
                        </button>
                    </div>
                </div>

                <!-- Add New Provider Form -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">‚ûï</span>
                        <span>Add New Provider</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="newProviderName" placeholder="Provider Name" class="input-field">
                        <input type="number" id="newProviderPriority" placeholder="Priority (0=highest)" class="input-field" min="0">
                        <input type="text" id="newProviderEndpoint" placeholder="Endpoint URL" class="input-field md:col-span-2">
                        <input type="text" id="newProviderModel" placeholder="Model Name" class="input-field">
                        <input type="password" id="newProviderApiKey" placeholder="API Key (optional)" class="input-field">
                    </div>
                    <button onclick="addNewProvider()" class="btn-primary mt-4">
                        Add Provider
                    </button>
                </div>

                <!-- OpenRouter BYOK Settings -->
                <div class="mb-8 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üîê</span>
                        <span>OpenRouter BYOK (Bring Your Own Key)</span>
                    </h3>
                    <p class="text-sm text-slate-400 mb-4">
                        Use your own API keys with OpenRouter (Cerebras, Google AI Studio, Groq, SambaNova, z.ai, etc.). 
                        <a href="https://openrouter.ai/settings/integrations" target="_blank" class="text-emerald-400 hover:underline">Add keys in OpenRouter ‚Üí</a>
                    </p>
                    
                    <!-- BYOK Enable/Disable -->
                    <div class="mb-4 flex items-center justify-between">
                        <label class="text-slate-300">Enable BYOK Mode</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="byokEnabled" class="sr-only peer" onchange="toggleBYOK()">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                        </label>
                    </div>

                    <!-- BYOK Provider Order -->
                    <div id="byokConfig" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">BYOK Provider Priority Order</label>
                            <p class="text-xs text-slate-500 mb-2">Drag to reorder. First = highest priority. Add any OpenRouter-supported BYOK provider.</p>
                            
                            <!-- Dynamic Provider List -->
                            <div id="byokProviderOrder" class="space-y-2">
                                <!-- Default providers - will be populated dynamically -->
                            </div>
                            
                            <!-- Add New BYOK Provider -->
                            <div class="mt-4 p-3 bg-slate-700/30 rounded-lg">
                                <label class="block text-xs font-medium text-slate-400 mb-2">Add New BYOK Provider</label>
                                <div class="flex gap-2">
                                    <input type="text" id="newBYOKProviderName" placeholder="Provider Name (e.g., SambaNova)" class="input-field text-sm flex-1">
                                    <input type="text" id="newBYOKProviderModel" placeholder="Model (e.g., sambanova/llama-3.2)" class="input-field text-sm flex-1">
                                    <button onclick="addBYOKProvider()" class="btn-secondary text-sm px-4">+ Add</button>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Popular: SambaNova, z.ai, Together AI, Hyperbolic, Fireworks, etc.
                                </p>
                            </div>
                        </div>

                        <!-- Fallback Toggle -->
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-slate-300">Fallback to OpenRouter Shared</label>
                                <p class="text-xs text-slate-500">Use OpenRouter's shared capacity if all BYOK providers fail</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="byokFallback" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                            </label>
                        </div>

                        <!-- Save BYOK Settings -->
                        <button onclick="saveBYOKSettings()" class="btn-primary w-full">
                            üíæ Save BYOK Configuration
                        </button>

                        <!-- Test BYOK -->
                        <button onclick="testBYOK()" class="btn-secondary w-full">
                            üß™ Test BYOK Setup
                        </button>
                    </div>
                </div>

                <!-- Providers List -->
                <div>
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span class="text-emerald-400">üìã</span>
                        <span>Configured Providers</span>
                    </h3>
                    <div id="providersList" class="space-y-3">
                        <div class="flex items-center gap-2 text-slate-400">
                            <div class="w-4 h-4 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-sm">Loading providers...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let token = localStorage.getItem('token');
        let username = localStorage.getItem('username');
        let chatHistory = [];
        let isLoading = false;
        let sidebarOpen = false;
        let currentSessionId = null;
        let currentTheme = localStorage.getItem('theme') || 'dark';
        const API_BASE = window.location.origin;

        function setTheme(themeName) {
            currentTheme = themeName;
            localStorage.setItem('theme', themeName);
            document.documentElement.setAttribute('data-theme', themeName);
            updateThemeButtons();
        }

        function updateThemeButtons() {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                const btnTheme = btn.getAttribute('data-theme');
                if (btnTheme === currentTheme) {
                    btn.classList.add('ring-2', 'ring-emerald-500', 'ring-offset-2', 'ring-offset-slate-900');
                } else {
                    btn.classList.remove('ring-2', 'ring-emerald-500', 'ring-offset-2', 'ring-offset-slate-900');
                }
            });
        }

        function initializeTheme() {
            setTheme(currentTheme);
        }
        
        function checkAuth() {
            const storedToken = localStorage.getItem('token');
            const storedUsername = localStorage.getItem('username');
            console.log('Checking auth, token:', storedToken ? 'exists' : 'none', 'username:', storedUsername);
            
            if (storedToken) {
                token = storedToken;
                username = storedUsername;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('currentUser').textContent = `üë§ ${username}`;
                loadDashboard();
            }
        }
        
        async function login() {
            const inputUsername = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!inputUsername || !password) {
                showError('Please enter username and password');
                return;
            }
            
            const btn = document.querySelector('#loginScreen .btn-primary');
            btn.disabled = true;
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
            
            try {
                const response = await fetch(API_BASE + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: inputUsername, password })
                });
                
                const text = await response.text();
                console.log('Login response:', text);
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('Failed to parse response:', e, 'Response text:', text);
                    showError('Invalid response from server: ' + (text.substring(0, 100) || 'Empty response'));
                    return;
                }
                
                if (!response.ok) {
                    showError(data.error || 'Login failed');
                    return;
                }
                
                if (data.token) {
                    token = data.token;
                    username = data.username;
                    localStorage.setItem('token', token);
                    localStorage.setItem('username', username);
                    checkAuth();
                } else {
                    showError(data.error || 'No token received');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Connection error: ' + error.message);
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span>üîê</span><span>Sign In</span>';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }
        
        function logout() {
            fetch(API_BASE + '/api/logout', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            token = null;
            location.reload();
        }
        
        function addMessage(role, content, ragContext = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble ' + role + ' message-animate';
            
            let html = formatContent(content);
            
            if (ragContext) {
                html += `
                    <div class="rag-context">
                        <div class="flex items-center gap-2 font-semibold text-emerald-400 mb-2 text-sm">
                            <span>üìö</span>
                            <span>Relevant Documents Found</span>
                        </div>
                        ${ragContext}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = html;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
        }
        
        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message-bubble assistant message-animate';
            typingDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="flex gap-1">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span class="text-slate-400 text-sm">AI is typing...</span>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function formatContent(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/##\s+/g, '<br><br><h2 class="text-xl font-bold text-emerald-300 mt-4 mb-2">')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-emerald-300">$1</strong>')
                .replace(/`([^`]+)`/g, '<code class="bg-slate-800 px-2 py-1 rounded text-sm text-emerald-400">$1</code>')
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-slate-800 p-3 rounded-lg mt-2 mb-2 overflow-x-auto text-sm"><code>$1</code></pre>');
        }
        
        function createStreamingMessage() {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble assistant message-animate';
            messageDiv.id = 'streamingMessage';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'streaming-content';
            contentDiv.innerHTML = '';
            messageDiv.appendChild(contentDiv);
            
            messagesDiv.appendChild(messageDiv);
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 50);
            
            return contentDiv;
        }

        async function sendMessage() {
            if (isLoading) return;
            
            const message = document.getElementById('messageInput').value.trim();
            if (!message) return;
            
            isLoading = true;
            const input = document.getElementById('messageInput');
            const sendBtn = document.querySelector('#mainApp .btn-primary');
            const provider = document.getElementById('providerSelect').value;
            
            input.disabled = true;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
            
            addMessage('user', message);
            chatHistory.push({ role: 'user', content: message });
            input.value = '';
            
            showTypingIndicator();

            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ 
                        message, 
                        provider,
                        session_id: currentSessionId 
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                hideTypingIndicator();
                
                const contentElement = createStreamingMessage();
                let fullResponse = '';
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            
                            if (data === '[DONE]') {
                                break;
                            }
                            
                            try {
                                const json = JSON.parse(data);
                                
                                if (json.session_id && !currentSessionId) {
                                    currentSessionId = json.session_id;
                                }
                                
                                if (json.content) {
                                    fullResponse += json.content;
                                    contentElement.innerHTML = formatContent(fullResponse);
                                    const messagesDiv = document.getElementById('chatMessages');
                                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                }
                                
                                if (json.error) {
                                    contentElement.innerHTML = '‚ùå ' + json.error;
                                }
                            } catch (e) {
                                console.error('Failed to parse SSE data:', e, 'Data:', data);
                            }
                        }
                    }
                }
                
                const streamingMessage = document.getElementById('streamingMessage');
                if (streamingMessage) {
                    streamingMessage.removeAttribute('id');
                }
                
                if (fullResponse) {
                    chatHistory.push({ role: 'assistant', content: fullResponse });
                    loadChatHistory();
                }
                
            } catch (error) {
                hideTypingIndicator();
                console.error('Stream error:', error);
                addMessage('assistant', '‚ùå Sorry, I encountered an error. Please try again.');
            }
            
            isLoading = false;
            input.disabled = false;
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<span id="sendIcon">üì§</span><span class="hidden sm:inline">Send</span>';
            input.focus();
        }
        
        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebarOpen) {
                sidebar.classList.remove('hidden');
                overlay.classList.add('show');
            } else {
                sidebar.classList.add('hidden');
                overlay.classList.remove('show');
            }
        }
        
        function closeSidebar() {
            sidebarOpen = false;
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('sidebarOverlay').classList.remove('show');
        }

        async function loadDashboard() {
            await Promise.all([loadSkills(), loadRAGStats(), loadChatHistory(), loadProviderSelect()]);
        }

        async function loadProviderSelect() {
            try {
                const response = await fetch('/api/providers', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const providers = await response.json();

                const select = document.getElementById('providerSelect');
                const currentValue = select.value;

                select.innerHTML = providers.map(p => `
                    <option value="${p.name}" ${p.is_default ? 'selected' : ''} ${!p.enabled ? 'disabled' : ''}>
                        ${p.byok ? 'üîê' : 'üåê'} ${p.name} ${p.is_default ? '(Default)' : ''}
                    </option>
                `).join('');

                if (currentValue && providers.find(p => p.name === currentValue)) {
                    select.value = currentValue;
                }
            } catch (error) {
                console.error('Failed to load providers:', error);
                const select = document.getElementById('providerSelect');
                select.innerHTML = `<option value="">Error: ${error.message}</option>`;
            }
        }


        async function loadSkills() {
            try {
                const response = await fetch('/api/skills', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                
                const skillsList = document.getElementById('skillsList');
                document.getElementById('skillCount').textContent = data.length || 0;
                
                if (!data || data.length === 0) {
                    skillsList.innerHTML = '<p class="text-slate-500 text-sm">No skills available</p>';
                    return;
                }
                
                skillsList.innerHTML = data.map(skill => `
                    <div class="skill-card" onclick="useSkill('${skill.name}')">
                        <div class="font-semibold text-emerald-400 text-sm">üéØ ${skill.name}</div>
                        <div class="text-xs text-slate-400 mt-1">${skill.description}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load skills:', error);
                document.getElementById('skillsList').innerHTML = '<p class="text-slate-500 text-sm">Failed to load skills</p>';
            }
        }
        
        async function loadRAGStats() {
            try {
                const response = await fetch('/api/rag/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ query: 'test' })
                });
                
                const data = await response.json();
                const docCount = data.results ? data.results.length : (data.count || 0);
                document.getElementById('ragDocCount').textContent = docCount > 0 ? docCount : '-';
                document.getElementById('ragIndexStatus').textContent = docCount > 0 ? '‚úÖ Active' : '‚ö†Ô∏è No docs';
                document.getElementById('ragLastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                document.getElementById('ragDocCount').textContent = '?';
                document.getElementById('ragIndexStatus').textContent = '‚ö†Ô∏è Error';
            }
        }
        
        function useSkill(skillName) {
            document.getElementById('messageInput').value = `${skillName}: `;
            document.getElementById('messageInput').focus();
        }

        async function loadChatHistory() {
            try {
                const response = await fetch('/api/history', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const sessions = await response.json();
                renderChatHistory(sessions);
            } catch (error) {
                console.error('Failed to load chat history:', error);
                document.getElementById('chatHistoryList').innerHTML =
                    '<p class="text-slate-500 text-sm">Failed to load history</p>';
            }
        }

        function renderChatHistory(sessions) {
            const historyList = document.getElementById('chatHistoryList');

            if (!sessions || sessions.length === 0) {
                historyList.innerHTML = '<p class="text-slate-500 text-sm">No chat sessions</p>';
                return;
            }

            historyList.innerHTML = sessions.map(session => `
                <div class="bg-slate-800/50 rounded-lg p-3 cursor-pointer hover:bg-slate-700/50 transition-colors border border-slate-700 ${currentSessionId === session.id ? 'border-emerald-500' : ''}" onclick="loadSession('${session.id}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-sm text-slate-200 truncate">${escapeHtml(session.title)}</div>
                            <div class="text-xs text-slate-400 mt-1">${session.messages.length} messages</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteSession('${session.id}')" class="text-slate-500 hover:text-red-400 transition-colors ml-2">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadSession(sessionId) {
            try {
                const response = await fetch(`/api/history/${sessionId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const session = await response.json();

                currentSessionId = sessionId;
                document.getElementById('chatMessages').innerHTML = '';

                session.messages.forEach(msg => {
                    if (msg.role === 'user') {
                        addMessage('user', msg.content);
                    } else {
                        addMessage('assistant', msg.content);
                    }
                });

                loadChatHistory();
            } catch (error) {
                console.error('Failed to load session:', error);
                addMessage('assistant', '‚ùå Failed to load session');
            }
        }

        async function startNewChat() {
            currentSessionId = null;
            document.getElementById('chatMessages').innerHTML = `
                <div class="message-animate message-bubble assistant">
                    üëã Welcome to Terminal AI! I'm ready to help you with your notes and documents.
                </div>
            `;
            loadChatHistory();
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this chat session?')) {
                return;
            }

            try {
                await fetch(`/api/history/${sessionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (currentSessionId === sessionId) {
                    startNewChat();
                } else {
                    loadChatHistory();
                }
            } catch (error) {
                console.error('Failed to delete session:', error);
                alert('Failed to delete session');
            }
        }

        async function saveMessageToSession(role, content) {
            if (!currentSessionId) {
                return;
            }

            try {
                await fetch(`/api/history/${currentSessionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        message: role === 'user' ? content : null,
                        provider: document.getElementById('providerSelect').value
                    })
                });
            } catch (error) {
                console.error('Failed to save message:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 500);
            checkAuth();
        });
        
        document.getElementById('messageInput').addEventListener('input', function(e) {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        async function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            await loadProviders();
            await loadBYOKSettings();
        }

        async function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            await loadProviderSelect();
        }

        async function loadProviders() {
            try {
                const response = await fetch('/api/providers', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const providers = await response.json();
                renderProviders(providers);
            } catch (error) {
                console.error('Failed to load providers:', error);
                document.getElementById('providersList').innerHTML =
                    `<div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-red-400">
                        <div class="font-semibold mb-1">Failed to load providers</div>
                        <div class="text-sm text-slate-400">${error.message}</div>
                    </div>`;
            }
        }

        function renderProviders(providers) {
            const list = document.getElementById('providersList');

            if (!providers || providers.length === 0) {
                list.innerHTML = '<p class="text-slate-500 text-sm">No providers configured</p>';
                return;
            }

            list.innerHTML = providers.map(p => `
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 ${p.enabled ? '' : 'opacity-60'}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h4 class="font-semibold text-lg">${escapeHtml(p.name)}</h4>
                                ${p.is_default ? '<span class="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-1 rounded-full">DEFAULT</span>' : ''}
                                ${p.byok ? '<span class="bg-blue-500/20 text-blue-400 text-xs px-2 py-1 rounded-full">BYOK</span>' : ''}
                                ${p.enabled ? '<span class="bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded-full">ENABLED</span>' : '<span class="bg-red-500/20 text-red-400 text-xs px-2 py-1 rounded-full">DISABLED</span>'}
                            </div>
                            <div class="text-sm text-slate-400 mt-1">Priority: ${p.priority}</div>
                            <div class="text-sm text-slate-400">Model: ${escapeHtml(p.model)}</div>
                            <div class="text-xs text-slate-500 mt-1 break-all">Endpoint: ${escapeHtml(p.endpoint)}</div>
                        </div>
                        <button onclick="deleteProvider('${p.name}')" class="text-red-400 hover:text-red-300 transition-colors">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${p.enabled ? `
                            <button onclick="toggleProvider('${p.name}', false)" class="btn-secondary text-xs px-3 py-1">
                                Disable
                            </button>
                        ` : `
                            <button onclick="toggleProvider('${p.name}', true)" class="btn-primary text-xs px-3 py-1">
                                Enable
                            </button>
                        `}
                        <button onclick="testProvider('${p.name}')" class="btn-secondary text-xs px-3 py-1">
                            Test
                        </button>
                        <button onclick="setDefaultProvider('${p.name}')" class="btn-secondary text-xs px-3 py-1">
                            Set Default
                        </button>
                        <div class="flex items-center gap-2 ml-auto">
                            <label class="text-sm text-slate-400">Priority:</label>
                            <input type="number" min="0" max="99" value="${p.priority}"
                                   onchange="updateProviderPriority('${p.name}', this.value)"
                                   class="bg-slate-900 border border-slate-700 rounded px-2 py-1 w-16 text-sm">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function addNewProvider() {
            const name = document.getElementById('newProviderName').value.trim();
            const priority = parseInt(document.getElementById('newProviderPriority').value) || 1;
            const endpoint = document.getElementById('newProviderEndpoint').value.trim();
            const model = document.getElementById('newProviderModel').value.trim();
            const apiKey = document.getElementById('newProviderApiKey').value.trim();

            if (!name || !endpoint || !model) {
                alert('Please fill in Name, Endpoint, and Model');
                return;
            }

            try {
                const response = await fetch('/api/providers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ name, priority, endpoint, model, api_key: apiKey })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                document.getElementById('newProviderName').value = '';
                document.getElementById('newProviderPriority').value = '';
                document.getElementById('newProviderEndpoint').value = '';
                document.getElementById('newProviderModel').value = '';
                document.getElementById('newProviderApiKey').value = '';

                await loadProviders();
                await loadProviderSelect();
            } catch (error) {
                alert('Failed to add provider: ' + error.message);
            }
        }

        async function toggleProvider(name, enabled) {
            try {
                const endpoint = enabled ? `/api/providers/${name}/enable` : `/api/providers/${name}/disable`;
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                await loadProviders();
            } catch (error) {
                alert('Failed to toggle provider: ' + error.message);
            }
        }

        async function testProvider(name) {
            try {
                const response = await fetch(`/api/providers/${name}/test`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const data = await response.json();
                alert(`Test successful!\nResponse: ${data.response}`);
            } catch (error) {
                alert('Test failed: ' + error.message);
            }
        }

        async function setDefaultProvider(name) {
            try {
                const response = await fetch(`/api/providers/${name}/default`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                await loadProviders();
            } catch (error) {
                alert('Failed to set default provider: ' + error.message);
            }
        }

        async function updateProviderPriority(name, priority) {
            try {
                const response = await fetch(`/api/providers/${name}/priority`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ priority: parseInt(priority) })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                await loadProviders();
            } catch (error) {
                alert('Failed to update priority: ' + error.message);
                await loadProviders();
            }
        }

        async function deleteProvider(name) {
            if (!confirm(`Delete provider '${name}'?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/providers/${name}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                await loadProviders();
            } catch (error) {
                alert('Failed to delete provider: ' + error.message);
            }
        }

        // OpenRouter BYOK Functions
        let byokProviders = []; // Store BYOK providers dynamically

        function toggleBYOK() {
            const enabled = document.getElementById('byokEnabled').checked;
            const configDiv = document.getElementById('byokConfig');
            if (enabled) {
                configDiv.classList.remove('hidden');
            } else {
                configDiv.classList.add('hidden');
            }
        }

        function createBYOKProviderElement(providerName, model, isDefault = false) {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 p-2 bg-slate-700/50 rounded-lg';
            div.setAttribute('data-provider', providerName);
            div.setAttribute('draggable', 'true');
            
            div.innerHTML = `
                <span class="cursor-move text-slate-400">‚ãÆ‚ãÆ</span>
                <input type="checkbox" checked class="byok-provider-checkbox rounded border-slate-600 text-emerald-500 focus:ring-emerald-500">
                <span class="flex-1 text-slate-300">${providerName}</span>
                <input type="text" placeholder="Model slug (e.g., provider/model-name)" 
                       class="byok-model-input input-field text-sm py-1 px-2 w-64" 
                       value="${model || ''}">
                <button onclick="removeBYOKProvider('${providerName}')" class="text-red-400 hover:text-red-300 px-2" title="Remove provider">
                    ‚úï
                </button>
            `;
            
            // Add drag event listeners
            div.addEventListener('dragstart', function(e) {
                draggedItem = e.target.closest('[data-provider]');
                e.target.closest('[data-provider]').style.opacity = '0.5';
            });

            div.addEventListener('dragend', function(e) {
                e.target.closest('[data-provider]').style.opacity = '1';
                draggedItem = null;
            });
            
            return div;
        }

        function renderBYOKProviders() {
            const container = document.getElementById('byokProviderOrder');
            container.innerHTML = '';
            
            byokProviders.forEach(provider => {
                const el = createBYOKProviderElement(provider.name, provider.model, provider.isDefault);
                container.appendChild(el);
            });
        }

        function addBYOKProvider() {
            const nameInput = document.getElementById('newBYOKProviderName');
            const modelInput = document.getElementById('newBYOKProviderModel');
            
            const name = nameInput.value.trim();
            const model = modelInput.value.trim();
            
            if (!name) {
                alert('Please enter a provider name');
                return;
            }
            
            // Check if provider already exists
            if (byokProviders.some(p => p.name === name)) {
                alert(`Provider '${name}' already exists`);
                return;
            }
            
            // Add to list
            byokProviders.push({
                name: name,
                model: model || '',
                isDefault: false
            });
            
            // Render updated list
            renderBYOKProviders();
            
            // Clear inputs
            nameInput.value = '';
            modelInput.value = '';
        }

        function removeBYOKProvider(providerName) {
            if (!confirm(`Remove '${providerName}' from BYOK list?`)) {
                return;
            }
            
            byokProviders = byokProviders.filter(p => p.name !== providerName);
            renderBYOKProviders();
        }

        async function saveBYOKSettings() {
            const enabled = document.getElementById('byokEnabled').checked;
            const allowFallback = document.getElementById('byokFallback').checked;
            
            // Collect provider order from DOM
            const providerItems = document.querySelectorAll('#byokProviderOrder > div');
            const providerOrder = [];
            const models = {};
            
            providerItems.forEach(item => {
                const checkbox = item.querySelector('.byok-provider-checkbox');
                if (checkbox.checked) {
                    const providerName = item.getAttribute('data-provider');
                    const modelInput = item.querySelector('.byok-model-input');
                    providerOrder.push(providerName);
                    // Use normalized key for model storage
                    const modelKey = providerName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                    models[modelKey] = modelInput.value;
                }
            });

            if (enabled && providerOrder.length === 0) {
                alert('Please select at least one BYOK provider');
                return;
            }

            try {
                const response = await fetch('/api/providers/openrouter/byok', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        enabled,
                        provider_order: providerOrder,
                        allow_fallback_to_shared: allowFallback,
                        models
                    })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                alert('BYOK settings saved successfully!');
            } catch (error) {
                alert('Failed to save BYOK settings: ' + error.message);
            }
        }

        async function testBYOK() {
            try {
                const response = await fetch('/api/providers/openrouter/byok/test', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const data = await response.json();
                
                let message = 'üß™ BYOK Test Results:\n\n';
                data.results.forEach(result => {
                    const icon = result.success ? '‚úÖ' : '‚ùå';
                    message += `${icon} ${result.provider}: ${result.message}\n`;
                });
                
                if (data.fallback_used) {
                    message += '\nüì° Fallback to OpenRouter shared was used';
                }
                
                alert(message);
            } catch (error) {
                alert('BYOK test failed: ' + error.message);
            }
        }

        async function loadBYOKSettings() {
            try {
                const response = await fetch('/api/providers/openrouter/byok', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const config = await response.json();
                
                // Set toggle state
                document.getElementById('byokEnabled').checked = config.enabled;
                document.getElementById('byokFallback').checked = config.allow_fallback_to_shared !== false;
                
                // Show/hide config section
                toggleBYOK();
                
                // Default providers if none configured
                const defaultProviders = [
                    { name: 'Cerebras', model: 'cerebras/llama-3.1-8b', isDefault: true },
                    { name: 'Google AI Studio', model: 'google/gemini-2.0-flash-exp:free', isDefault: true },
                    { name: 'Groq', model: 'groq/llama-3.3-70b-versatile', isDefault: true }
                ];
                
                // Load providers from config or use defaults
                if (config.provider_order && config.provider_order.length > 0) {
                    byokProviders = config.provider_order.map(providerName => {
                        const modelKey = providerName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                        const defaultProvider = defaultProviders.find(p => p.name === providerName);
                        return {
                            name: providerName,
                            model: config.models[modelKey] || (defaultProvider ? defaultProvider.model : ''),
                            isDefault: defaultProviders.some(p => p.name === providerName)
                        };
                    });
                    
                    // Add any default providers not in the saved order
                    defaultProviders.forEach(defaultP => {
                        if (!byokProviders.some(p => p.name === defaultP.name)) {
                            byokProviders.push({ ...defaultP });
                        }
                    });
                } else {
                    // Use default providers
                    byokProviders = [...defaultProviders];
                }
                
                // Render providers
                renderBYOKProviders();
                
            } catch (error) {
                console.error('Failed to load BYOK settings:', error);
                // Use defaults on error
                byokProviders = [
                    { name: 'Cerebras', model: 'cerebras/llama-3.1-8b', isDefault: true },
                    { name: 'Google AI Studio', model: 'google/gemini-2.0-flash-exp:free', isDefault: true },
                    { name: 'Groq', model: 'groq/llama-3.3-70b-versatile', isDefault: true }
                ];
                renderBYOKProviders();
            }
        }

        // Simple drag and drop for BYOK provider order
        let draggedItem = null;

        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('byokProviderOrder');
            if (container) {
                container.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(container, e.clientY);
                    if (draggedItem) {
                        if (afterElement == null) {
                            container.appendChild(draggedItem);
                        } else {
                            container.insertBefore(draggedItem, afterElement);
                        }
                    }
                });
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('[data-provider]:not([style*="opacity: 0.5"])')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    </script>
</body>
</html>
